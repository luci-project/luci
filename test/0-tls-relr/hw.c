#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <pthread.h>


const char *str[1000] = {
	"hallo", "hello", "hola", "bonjour",

	[100] = "welt", "world", "mundo", "monde",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "!", "!", "!", "!", "!",
	        "!", "!", "!", "!", "!", "[end of test]"
};

__thread const char *tls[] = { "this", "is", "a", "thread", "local", "storage", "variable", NULL };

__thread const char *shared[] = { "this", "is", "a", "shared", "variable", NULL };
const char ** shared_ptr;

void *func(void *ptr) {
	long id = (long)ptr;

	sleep(id);

	printf("\nThread %ld:\n", id);

	const char * replace[] = { "thread", "modifed", "the" };

	for (int i = 0; tls[i] != NULL; i++) {
		printf("%s ", tls[i]);
		if (i < 3)
			tls[i] = replace[i];
	}
	puts("");
	for (int i = 0; shared_ptr[i] != NULL; i++) {
		printf("%s ", shared_ptr[i]);
		if (i < 3)
			shared_ptr[i] = replace[i];
	}
	puts("");
	return NULL;
}

#define CHECK_ERROR(FUNC)                                   \
	do {                                                    \
		int e = (FUNC);                                     \
		if (e != 0) {                                       \
			printf("%s failed: %s\n", #FUNC, strerror(e));  \
			exit(EXIT_FAILURE);                             \
		}                                                   \
	} while(0)

int main() {
	for (int i = 0; i <= 3; i++)
		printf("%s %s%s\n", str[i], str[i + 100], str[i * 0xff + 200]);
	printf("%s\n", str[999]);

	shared_ptr = shared;
	pthread_t t1, t2;
	CHECK_ERROR(pthread_create(&t1, NULL, &func, (void*)1));
	CHECK_ERROR(pthread_create(&t2, NULL, &func, (void*)2));

	void * r = NULL;
	CHECK_ERROR(pthread_join(t1, &r));
	CHECK_ERROR(pthread_join(t2, &r));

	return 0;
}
